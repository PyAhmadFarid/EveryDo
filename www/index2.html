<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/index.css" rel="stylesheet">
    <script src="js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <title>EveryDo</title>
</head>

<body class=" hidden">
    <div class=" w-screen h-screen flex flex-col">
        <div class=" absolute w-screen h-screen z-10 tools pointer-events-none opacity-0">
            <div class="w-screen h-screen absolute transition-all" onclick="displayAddTask()"></div>
        </div>

        <div class="h-full overflow-y-auto">

            <div class="page new text-niceBlack">
                <h1 class=" font-bold text-2xl text-niceBlue m-7">Hello, Guest!</h1>
                <img class=" m-auto" src="img/emptystate_noresult.png" alt="">
                <div class=" text-center p-7">
                    <div class=" font-bold text-2xl mb-3">
                        You've no task
                    </div>
                    <p class="mb-3">
                        Create your first task or you can login with your existing account.
                    </p>
                </div>
                <div class=" w-full px-7">
                    <a href="login.html"
                        class=" block text-center bg-niceBlue rounded-2xl w-full p-4 font-bold text-white">
                        Login
                    </a>
                </div>

            </div>

            <div class="page home">
                <h1 class=" font-bold text-2xl text-niceBlue m-7">Hello, <span class="Name">Guest</span> !</h1>

                <!-- today -->
                <div>
                    <span class=" text-niceBlack items-start flex mx-7 font-bold text-xl">Today! <span
                            class="pl-2 text-sm TodayTaskCount">(0)</span></span>

                    <div class=" py-4 overflow-x-auto">

                        <div class=" px-5 flex TodayTaskSection">

                            <!-- <button class=" taskBtn">
                                <span class=" taskBtnCategory">School</span>
                                <div class=" taskBtnName">Tugas
                                    Dari
                                    Bu Guru</div>
                                <span class="  taskBtnDate">
                                    <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                                </span>
                            </button> -->





                            <!-- pelengkap -->
                            <div class="pr-6">
                            </div>







                        </div>
                    </div>
                </div>

                <!-- to Do task -->
                <div>
                    <span class=" text-niceBlack items-start flex mx-7 font-bold text-xl">To Do <span
                            class="pl-2 text-sm ToDoTaskCount">(0)</span></span>

                    <div class=" py-4 overflow-x-auto">

                        <div class=" px-5 flex ToDoTaskSection">

                            <!-- <button class=" taskBtn">
                                <span class=" taskBtnCategory">School</span>
                                <div class=" taskBtnName">Tugas
                                    Dari
                                    Bu Guru</div>
                                <span class="  taskBtnDate">
                                    <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                                </span>
                            </button>


                            <button class=" taskBtn">
                                <span class=" taskBtnCategory">School</span>
                                <div class=" taskBtnName">Tugas
                                    Dari
                                    Bu Guru</div>
                                <span class="  taskBtnDate">
                                    <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                                </span>
                            </button> -->

                            <!-- pelengkap -->
                            <div class="pr-6">
                            </div>

                        </div>
                    </div>
                </div>

                <!-- hisory -->
                <div>
                    <span class=" text-niceBlack items-start flex mx-7 font-bold text-xl">History <span
                            class="pl-2 text-sm HistoryTaskCount">(0)</span></span>

                    <div class=" py-4 overflow-x-auto">

                        <div class=" px-5 flex HistoryTaskSection">

                            <!-- <button class=" taskBtn">
                                <span class=" taskBtnCategory">School</span>
                                <div class=" taskBtnName">Tugas
                                    Dari
                                    Bu Guru</div>
                                <span class="  taskBtnDate">
                                    <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                                </span>
                            </button>


                            <button class=" taskBtn">
                                <span class=" taskBtnCategory">School</span>
                                <div class=" taskBtnName">Tugas
                                    Dari
                                    Bu Guru</div>
                                <span class="  taskBtnDate">
                                    <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                                </span>
                            </button> -->


                            <!-- pelengkap -->
                            <div class="pr-6">
                            </div>







                        </div>
                    </div>
                </div>

            </div>

            <div class="page mytask flex flex-col">
                <div class="px-6 pt-10 w-full bg-white">
                    <input placeholder="I want to search..." type="text"
                        class=" py-2 px-3 rounded-lg w-full border border-gray-300" onkeyup="filter()" id="value">
                    <img class="  transform -translate-x-5 -translate-y-8 float-right" src="icons/search-20px.svg"
                        alt="">
                </div>
                <div class="flex flex-wrap px-4 justify-center overflow-y-auto pb-10 MyTaskSection">

                    <!-- 
                    <button class=" taskBtn">
                        <span class=" taskBtnCategory">School</span>
                        <div class=" taskBtnName">Tugas
                            Dari
                            Bu Guru</div>
                        <span class="  taskBtnDate">
                            <div class="taskBtnCircle bg-niceRed "></div> till 28 Aug 2021
                        </span>
                    </button> -->

                </div>





            </div>

            <div class="page profile">
                <div class="h-full overflow-y-auto">
                    <div class=" flex justify-between m-6">
                        <button>
                            <img src="icons/back-24px.svg" alt="">
                        </button>
                    </div>

                    <div class="m-7 ">
                        <img onclick="changePhoto()" src="img/jokowi.jpg" alt="foto-profile"
                            class="profilePicture mx-auto h-40 w-40 rounded-full">
                    </div>
                    <div class=" font-bold text-2xl text-niceBlue mx-7 text-center userNameBaner">Fini Charista</div>
                    <div class="m-7 ">
                        <span class="font-bold text-gray-300 ">Name</span>
                        <input type="text" class="inpname w-full border border-niceBlack p-2 rounded-xl mt-2"
                            name="name" placeholder="Your Name" required>
                    </div>
                    <div class="m-7 ">
                        <span class="font-bold text-gray-300">Email</span>
                        <input type="email" class="inpemail w-full border border-niceBlack p-2 rounded-xl mt-2"
                            name="email" placeholder="ex: youremail@gmail.com" required>
                    </div>
                    <div class="m-7 ">
                        <span class="font-bold text-gray-300">Password</span>
                        <input type="password" class=" inppassword w-full border border-niceBlack p-2 rounded-xl mt-2"
                            name="password"
                            placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;"
                            required>
                    </div>
                    <div class="mx-7 mb-4">
                        <span class="font-bold text-gray-300">Re-Type Password</span>
                        <input type="password" class="inpreassword w-full border border-niceBlack p-2 rounded-xl mt-2"
                            name="repassword"
                            placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;"
                            required>
                    </div>
                    <div class="mt-7 mx-7">
                        <button onclick="updateProfile()"
                            class="mt-4 py-4 bg-niceBlue text-white font-bold h-full w-full rounded-2xl">Save
                            Changes</button>
                    </div>
                    <div class="mx-7 pb-6">
                        <button onclick="logout()"
                            class="mt-4 py-4 bg-gray-100 text-blue-700 font-bold h-full w-full rounded-2xl">Logout</button>
                    </div>


                </div>
            </div>


        </div>

        <button class=" absolute bottom-28 right-5 addBtn transition-all" id="add-task" onclick="displayAddTask()" style="display: inline-block;">
            <img class=" w-20 h-20" src="icons/add_task-44px.svg" alt="">
        </button>

        <button class=" absolute bottom-28 right-5 addBtn z-20 transition-all" id="close-add-task" onclick="displayAddTask()" style="display: none;">
            <img class=" w-20 h-20 transform rotate-45" src="icons/add_task-44px.svg" alt="">
        </button>

        <button class=" absolute bottom-28 right-5 addBtn mb-20 mr-3 rounded-lg px-4 z-20 transition-all" id="detail-add-task" onclick="" style="background-color: #505765; display: none;">
            <ul class="list-inside bg-rose-200 text-white">
                <li class="my-2 py-1"><a onclick="GoToJoin()"><img class=" w-5 h-5 float-left mx-2" src="icons/plus.svg" alt="">Join Task </a></li>
                <li class="my-2 py-1"><a onclick="GoToAdd()"><img class=" w-5 h-5 float-left mx-2" src="icons/pen.svg" alt="">Create Task </a></li>
            </ul>
        </button>

        <div class=" h-bar w-full flex justify-center items-center space-x-2 text-gray-400 shadow-bar">
            <button onclick="GoToPage(0)"
                class="btnhome pageBtn flex flex-col items-center space-y-2 font-medium text-xs px-7 ">
                <img class=" w-5 h-5 pageIcon iconhome" src="icons/home.svg" alt="home">
                <span>Home</span>
            </button>
            <button onclick="GoToPage(1)"
                class="btnmytask pageBtn flex flex-col items-center space-y-2 font-medium text-xs px-7">
                <img class=" w-5 h-5 pageIcon iconmytask" src="icons/mytask.svg" alt="mytask">
                <span>My Task</span>
            </button>
            <button onclick="GoToPage(2)"
                class="btnprofile pageBtn flex flex-col items-center space-y-2 font-medium text-xs px-7">
                <img class=" w-5 h-5 pageIcon iconprofile" src="icons/profile.svg" alt="profile">
                <span>Profile</span>
            </button>

        </div>

    </div>
</body>

<script>

    let User = null;
    if (localStorage.getItem("user") != undefined) {
        User = JSON.parse(localStorage.getItem("user"));
        $(".userNameBaner").html(User.user.name);
        $(".inpname").val(User.user.name);
        $(".Name").html(User.user.name);
        $(".inpemail").val(User.user.email);

        if(User.user.profile_pic !== null){
            
        }

    }


    var pages = ["home", "mytask", "profile", "new"]
    function GoToPage(iid) {

        if ((localStorage.getItem("user") == undefined) && (iid === 2)) {
            window.location.href = "login.html";
        } else {
            if (User != null) {

            }
        }

        if ((localStorage.getItem("myTask") == undefined) && (localStorage.getItem("user") == undefined) && (iid === 0)) {
            $(".page").addClass(" hidden");
            $("." + pages[3]).removeClass(" hidden");

        } else {
            $(".page").addClass(" hidden");
            $("." + pages[iid]).removeClass(" hidden");
        }

        $(".pageBtn").removeClass("text-niceBlue");
        $(".btn" + pages[iid]).addClass("text-niceBlue");

        if (iid === 2) {    
            document.getElementById("add-task").style.display = "none";
            document.getElementById("close-add-task").style.display = "none";
            document.getElementById("detail-add-task").style.display = "none";
        } else {
            document.getElementById("add-task").style.display = "inline-block";
        }





        ///
        //pages.forEach((i) => {
        //    $(".icon" + i).attr("src", "icons/" + i + ".svg");
        //});

        ///$('.icon' + pages[iid]).attr("src", "icons/" + pages[iid] + "-active.svg");

    }
    GoToPage(0)

    function getUserProfile() {
        $.get({
            url: "https://everydo.herokuapp.com/api/user/user-profile",
            headers: { "Authorization": "Bearer " + User.access_token },
            success: dt => {
                console.log(dt);
            }
        })
    }

    function refreshtoken() {
        $.post({
            url: "https://everydo.herokuapp.com/api/user/refresh-token",
            headers: { "Authorization": "Bearer " + User.access_token },
            success: dt => {
                console.log(dt);
                User = dt;
            }

        })
    }


    function logout() {
        console.log("logout");
        $.post({
            url: "https://everydo.herokuapp.com/api/user/logout",
            headers: { "Authorization": "Bearer " + User.access_token },
            success: (dt) => {
                console.log(dt);
                if (dt.message === "User successfully signed out") {
                    console.log(dt);
                    User = localStorage.removeItem("user");
                    location.reload();
                } else if (dt.status === "Token is Expired") {
                    //refresh token
                    refreshtoken()
                    logout();
                } else {
                    localStorage.removeItem("user");
                    location.reload();
                }

            }
        })

    }

    var myTask = JSON.parse(localStorage.getItem("myTask"));
    function GoToAdd() {
        window.location.href = "addTask.html"
    }

    function GoToJoin() {
        window.location.href = "joinTask.html"
    }

    var toolsActive = false;
    function displayAddTask() {    
        toolsActive = !toolsActive;    

        if (toolsActive) {            
            document.getElementById("add-task").style.display = "none";
            document.getElementById("close-add-task").style.display = "inline-block";
            document.getElementById("detail-add-task").style.display = "inline-block";
            $(".tools").removeClass("pointer-events-none");
            $(".tools").removeClass("opacity-0");
            $(".tools").addClass("bg-black");
            $(".tools").addClass("opacity-50");


        } else {
            document.getElementById("detail-add-task").style.display = "none";
            document.getElementById("close-add-task").style.display = "none";
            document.getElementById("add-task").style.display = "inline-block";
            $(".tools").addClass("pointer-events-none");
            $(".tools").addClass("opacity-0");
            $(".tools").removeClass("bg-black");
            $(".tools").removeClass("opacity-50");
        }
    }

    function GoToTask(id) {
        window.location.href = "task.html?id=" + id;
    }
    
    function buildTaskBtn(data) {

        let date = new Date(data.EndDate);
        date.setHours(0, 0, 0, 0);
        let today = new Date();
        today.setHours(0, 0, 0, 0);

        let taskBtn = $("<button>").addClass("taskBtn");
        taskBtn.attr('onclick', "GoToTask(" + data.id + ")");
        let taskBtnCategory = $("<span>").addClass("taskBtnCategory");
        taskBtnCategory.append(data.TaskCategory);
        taskBtn.append(taskBtnCategory);

        let taskBtnName = $("<div>").addClass("taskBtnName");
        taskBtnName.append(data.TaskName);
        taskBtn.append(taskBtnName);

        let section = 0;

        let taskBtnDate = $("<span>").addClass("taskBtnDate");
        let taskBtnCircle = $("<div>").addClass("taskBtnCircle");
        if (date.getTime() === today.getTime()) {
            taskBtnCircle.addClass("bg-niceRed");
        } else if (date.getTime() > today.getTime()) {
            taskBtnCircle.addClass("bg-niceGreen");
            section = 1;
        } else {
            taskBtnCircle.addClass("bg-niceBlue");
            section = 2;
        }
        taskBtnDate.append(taskBtnCircle);
        taskBtnDate.append(date.toDateString());
        taskBtn.append(taskBtnDate);

        return { task: taskBtn, section: section };





    }

    //make task
    let t = [];

    $(".TodayTaskSection").empty();
    $(".ToDoTaskSection").empty();
    $(".HistoryTaskSection").empty();
    $(".MyTaskSection").empty();
    let count = [0, 0, 0];
    if (localStorage.getItem("myTask") != undefined) {
        myTask.forEach(dt => {
            let task = buildTaskBtn(dt);
            $(".MyTaskSection").append(task.task.clone());

            console.log(task.section)
            switch (task.section) {
                case 0:
                    $(".TodayTaskSection").append(task.task);
                    count[0] += 1;
                    break;
                case 1:
                    $(".ToDoTaskSection").append(task.task);
                    count[1] += 1;
                    break;
                case 2:
                    $(".HistoryTaskSection").append(task.task);
                    count[2] += 1;
                    break;
            }


        })
    }
    $(".TodayTaskCount").html("(" + count[0] + ")");
    $(".ToDoTaskCount").html("(" + count[1] + ")");
    $(".HistoryTaskCount").html("(" + count[2] + ")");

    //let tb = $("<div>").addClass("pr-6");
    $(".TodayTaskSection").append($("<div class='pr-6'>"));
    $(".ToDoTaskSection").append($("<div class='pr-6'>"));
    $(".HistoryTaskSection").append($("<div class='pr-6'>"));


    $(document).ready(function () {
        $('body').show();
        //$('msg').hide();
    });

    // Search Tugas
    function filter() {
        var value, name, task, i;
        value = document.getElementById("value").value.toUpperCase();
        task = document.getElementsByClassName("taskBtn");
        for (i = 0; i < task.length; i++) {
            name = task[i].getElementsByClassName("taskBtnName");
            if (name[0].innerHTML.toUpperCase().indexOf(value) > -1) {
                task[i].style.display = "flex";
            } else {
                task[i].style.display = "none";
            }
        }
    }


    var photo;
    function changePhoto() {
        let input = document.createElement('input');
        input.type = 'file';
        input.onchange = _ => {
            // you can use this method to get file and perform respective operations
            photo = Array.from(input.files)[0];

            let aa = window.URL.createObjectURL(photo);
            $(".profilePicture").attr("src", aa);

            updatePhoto();


        };
        input.click();
    }


    function updatePhoto() {
        var formData = new FormData();
        formData.append("photo", photo);
        console.log(formData);
        $.post({
            url: "https://everydo.herokuapp.com/api/user/profile-picture",
            headers: { "Authorization": "Bearer " + User.access_token },
            enctype: 'multipart/form-data',
            processData: false,
            contentType: false,
            data: formData,
            success: (dt) => {
                if (dt.message === "Image successfully uploaded") {
                    console.log(dt);
                    User.user = dt.user;
                    localStorage.setItem("user", JSON.stringify(User));
                }

            }
        })
    }

    function updateProfile() {
        let inps = ["name", "email", "password"]

        let data = {};
        inps.forEach(e => {
            if ($(".inp" + e).val() !== "") {
                data[e] = $(".inp" + e).val();
            }

        })
        if ((data.password !== undefined) && (data.password !== $(".inprepassword"))) {
            $(".userPassword").removeClass("border-niceBlack");
            $(".userRePassword").removeClass("border-niceBlack");
            $(".userRePassword").addClass("border-niceRed");
            $(".userPassword").addClass("border-niceRed");
        }



        $.ajax({
            type: "PUT",
            url: "https://everydo.herokuapp.com/api/user/update",
            headers: { "Authorization": "Bearer " + User.access_token },
            data: data,
            success: (dt) => {
                console.log(dt);
                User.user = dt.user;
                localStorage.setItem("user", JSON.stringify(User));
            }

        })



    }
</script>

</html>