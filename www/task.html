<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/index.css" rel="stylesheet">
    <script src="js/jquery-3.6.0.min.js"></script>
    <title>Document</title>
</head>

<body class=" hidden">
    <div class=" absolute w-screen h-screen z-10 tools pointer-events-none overflow-hidden">

        <div
            class=" rounded-t-2xl bg-white bottom-0 absolute w-full z-20 transform transition-all hidenTools translate-y-full">
            <div class="px-10 py-5">
                <div class=" m-auto w-10 h-2 rounded-full bg-gray-800"></div>
                <div class=" font-bold text-2xl py-3 text-gray-700 pt-10">
                    Additional Menu
                </div>
                <button onclick="goToCheckListFile()" class=" w-full border-b text-left py-3">Check List File</button>
                <button class=" w-full border-b text-left py-3">Delete Task</button>
            </div>
            <div class="h-bar w-full flex justify-center items-center space-x-2 text-gray-400 shadow-bar px-5 py-6">
                <button onclick="setTools()"
                    class="  bg-niceBlue text-white font-bold h-full w-full rounded-2xl">Close</button>
            </div>
        </div>


        <div class="bg-black w-screen h-screen absolute blackScreen transition-all opacity-0" onclick="setTools()">

        </div>
    </div>


    <div class=" w-screen h-screen flex flex-col">


        <div class="h-full overflow-y-auto">


            <div class=" flex justify-between m-6">
                <button onclick="GoToBack()">
                    <img src="icons/back-24px.svg" alt="">
                </button>
                <button class="setToolsBtn" onclick="setTools()">
                    <img src="icons/more-24px.svg" alt="">
                </button>
            </div>

            <div class="p-7">
                <span class=" font-bold text-gray-300 TaskCategory">School</span>
                <div class=" font-bold text-2xl text-niceBlack py-2 TaskName">Mathematics Grade 12</div>
                <span class=" font-bold text-gray-300 TaskDate">25 Aug 2021 - 10 Sep 2021</span>
            </div>
            <div class=" items-center text-lg px-7 user hidden">
                <img class=" h-10 w-10 rounded-full mr-2 inline" src="img/jokowi.jpg" alt="">
                <span class="userName">Fini Charisa</span>

            </div>
            <div class="px-7 pt-7">
                <span class=" font-bold text-gray-300">ID</span>
                <div class=" text-lg pt-2 flex items-center">

                    <span class="TaskID">
                        HESOYAM
                    </span>
                    <button onclick="copyCode()" class=" text-niceBlack bg-blueGray p-1 ml-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </button>



                </div>
            </div>
            <div class="p-7">
                <span class=" font-bold text-gray-300">Descriptions</span>
                <p class=" text-lg pt-2 TaskDescriptions">
                    Make sure all task is written on a book or paper. Submit it on time!
                </p>
            </div>

            <div class=" px-7 pb-7 todos hidden">
                <span class=" font-bold text-gray-300">Todo</span>
                <div class=" flex flex-col text-lg subTask">

                    <a class=" font-bold text-niceBlack pt-2" href="">
                        Task 1 : Research About Algorithm
                    </a>
                    <a class=" font-bold text-niceBlack pt-2" href="">
                        Task 2 : Operational Mathematics
                    </a>
                </div>
            </div>

            <div class="">
                <span class=" font-bold text-gray-300 px-7">Assign</span>
                <div class="w-full flex overflow-x-auto space-x-3 pt-2">
                    <div class="pl-4"></div>
                    <img class="joinUserPhoto flex-none w-14 h-14 rounded-xl" src="img/jokowi.jpg" alt="">
                    <img class="joinUserPhoto flex-none w-14 h-14 rounded-xl" src="img/jokowi.jpg" alt="">
                    <img class="joinUserPhoto flex-none w-14 h-14 rounded-xl" src="img/jokowi.jpg" alt="">
                    <button class="flex-none flex w-14 h-14 justify-center items-center bg-blueGray rounded-xl">
                        <img class=" w-14 h-14" src="icons/share-40px.svg" alt="">
                    </button>
                    <div class="pr-4"></div>
                </div>
            </div>


            <div class="p-7 attacment hidden">
                <span class=" font-bold text-gray-300">Attachments</span>
                <div class="my-3 ">
                    <img class=" w-5 h-5 pageIcon float-left" src="icons/attachment-docs-20px.svg"
                        alt="attachment-docs">
                    <p class="pl-7 text-base attacmentfile">Fini_101511513921_Task1.docx</p>
                </div>
            </div>





        </div>

        <button class=" absolute bottom-28 right-5 addBtn" onclick="GoToAddSubTask()">
            <img class=" w-20 h-20" src="icons/add_task-44px.svg" alt="">
        </button>

        <div class="h-bar w-full flex justify-center items-center space-x-2 text-gray-400 shadow-bar px-5 py-6">
            <button onclick="joinTask()"
                class=" bg-niceBlue text-white font-bold h-full w-full rounded-2xl joinbtn">Join</button>
        </div>
    </div>

</body>


<script>
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('id');

    var User;
    if (localStorage.getItem("user") != undefined) {
        User = JSON.parse(localStorage.getItem("user"));

    }

    let idx;

    console.log(taskId)

    function GoToAddSubTask() {
        window.location.href = "addSubTask.html?id=" + taskId;
    }
    function GoToBack() {
        //console.log(window.history);
        window.location.href = "index.html"
    }

    function goToCheckListFile() {
        window.location.href = "checkList.html?id=" + taskId;
    }



    let allTask = JSON.parse(localStorage.getItem("myTask"));

    var myTask;

    var joined = false;

    if (allTask) {
        allTask.forEach((e, i) => {
            if (e.id == taskId) {
                myTask = e;
                idx = i
            }
        })
    }

    console.log("idx", allTask);

    if (myTask === undefined) {
        //mencari di dtabase
        
        console.log("tidak ada")
        $.get({
            url: "https://everydo.herokuapp.com/api/task/" + taskId,
            headers: { "Authorization": "Bearer " + User.access_token },
            success: dt => {
                joined = true;
                console.log(dt);
                myTask = {
                    "TaskCategory": dt.data.category,
                    "TaskName": dt.data.title,
                    "second_id": dt.data.second_id,
                    "StartDate": dt.data.start,
                    "EndDate": dt.data.start,
                    "TaskDescription": dt.data.desc,
                    "file": dt.data.file,
                    "create_by": dt.data.user_id,
                    "id": dt.data.id
                }
                show();
                $("body").show();
            }
        })
    }
    else {
        show()
    }


    function show() {
        console.log(myTask)
        $(".TaskCategory").html(myTask.TaskCategory);
        $(".TaskName").html(myTask.TaskName);
        $(".TaskID").html(myTask.second_id);
        const sdate = new Date(myTask.StartDate).toDateString()
        const ndate = new Date(myTask.EndDate).toDateString()
        $(".TaskDate").html(sdate + " - " + ndate);
        $(".TaskDescriptions").html(myTask.TaskDescription);


        if (myTask.file != undefined) {
            $(".attacment").show();
            let subss = myTask.file.split("/")
            $(".attacmentfile").html(subss[subss.length - 1]);
        }
        if ((myTask.user_id !== User.user.id)) {
            $(".addBtn").hide();
        }
        if (!joined) {
            //
            $(".joinbtn").removeClass("bg-niceBlue");
            $(".joinbtn").addClass("bg-gray-300");

        } else {
            $(".joinbtn").addClass("bg-niceBlue");
            $(".joinbtn").removeClass("bg-gray-200");

        }

        if (myTask.create_by !== User.id) {
            $.get({
                url: "https://everydo.herokuapp.com/api/subtask/" + myTask.id,
                headers: { "Authorization": "Bearer " + User.access_token },
                success: dt => {
                    console.log(dt);
                    myTask.subTask = [];
                    dt.data.forEach(e => {

                        myTask.subTask.push({
                            "TaskName": e.title,
                            "id": e.id,
                            "TaskDescription": e.desc
                        })
                    })
                    showSubTask();
                    console.log("aa")
                    allTask[idx] = myTask;
                    localStorage.setItem("myTask", JSON.stringify(allTask));


                }

            })

            $(".setToolsBtn").addClass("opacity-0 pointer-events-none");


        } else {
            showSubTask();
        }


    }


    function copyCode() {
        //window.prompt("Copy to clipboard: Ctrl+C, Enter", myTask.second_id);
        navigator.clipboard.writeText(myTask.second_id);
        alert("code telah di copy")
    }


    var toolsActive = false;
    function setTools() {
        toolsActive = !toolsActive;
        if (toolsActive) {
            $(".tools").removeClass("pointer-events-none");
            $(".hidenTools").removeClass("translate-y-full");
            $(".blackScreen").removeClass("opacity-0");
            $(".blackScreen").addClass("opacity-50");


        } else {
            $(".tools").addClass("pointer-events-none");
            $(".hidenTools").addClass("translate-y-full");
            $(".blackScreen").addClass("opacity-0");
            $(".blackScreen").removeClass("opacity-50");
        }



    }


    function toDetail(taskid, todoid) {
        window.location.href = "detailSubTask.html?taskid=" + taskid + "&todoid=" + todoid;
    }

    function showSubTask() {
        console.log("showSub task")
        $(".subTask").empty()
        if ((myTask.subTask !== undefined) && (myTask.subTask.length !== 0)) {
            $(".todos").show();
            myTask.subTask.forEach((e, i) => {
                let subs = $("<a>").addClass("font-bold text-niceBlack pt-2");
                subs.html(e.TaskName);
                subs.attr("onclick", "toDetail(" + myTask.id + "," + i + ")");
                let arrow =
                    $('<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 float-right" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>');
                subs.append(arrow);
                $(".subTask").append(subs);

            })
        }
    }

    function joinTask() {
        $.get({
            url: "https://everydo.herokuapp.com/api/task/tasktome/" + taskId,
            headers: { "Authorization": "Bearer " + User.access_token },
            success: (dt) => {
                console.log(dt);
                if (dt.message === "the task was successfully added to your account") {
                    $(".joinbtn").removeClass("bg-niceBlue");
                    $(".joinbtn").addClass("bg-gray-300");


                    let ttk = {
                        "TaskCategory": dt.task.category,
                        "TaskName": dt.task.title,
                        "second_id": dt.task.second_id,
                        "StartDate": dt.task.start,
                        "EndDate": dt.task.start,
                        "TaskDescription": dt.task.desc,
                        "id": dt.task.id,
                        "file": dt.task.file,
                        "create_by": dt.task.user_id
                    }
                    allTask.push(ttk);
                    localStorage.setItem("myTask", JSON.stringify(allTask));
                }
            }


        })
    }

    //send subTask



    //showSubTask()

    //if (myTask.shared === false) {
    //$(".joinUserPhoto").hide();
    //$(".user").hide();
    //}

    if (User) {
        $(".user").show();
        $(".userName").html(User.user.name);
    }

    $(document).ready(function () {
        $('body').show();
        //$('msg').hide();
    });
</script>

</html>